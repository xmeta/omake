<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
            "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>



<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META name="GENERATOR" content="hevea 1.08">
<LINK rel="stylesheet" type="text/css" href="omake-doc.css">
<TITLE>
Build functions
</TITLE>
</HEAD>
<BODY >

<img src="images/omake-manual.gif" border="0" align="top" alt=""><br>

<TABLE CELLSPACING=2 CELLPADDING=0>
<TR><TD ALIGN=left NOWRAP>Jump to:</TD>
<TD VALIGN=top ALIGN=center NOWRAP>&nbsp;&nbsp;</TD>
<TD ALIGN=left NOWRAP><A HREF="http://omake.metaprl.org/">OMake Home</A>
&bull;&nbsp;<A HREF="omake.html">Guide Home</A>
&bull;&nbsp;<A HREF="omake-doc.html">Guide (single-page)</A>
&bull;&nbsp;<A HREF="omake-toc.html">Contents (short)</A>
&bull;&nbsp;<A HREF="omake-contents.html">Contents (long)</A></TD>
</TR>
<TR><TD ALIGN=left NOWRAP>Index:</TD>
<TD VALIGN=top ALIGN=center NOWRAP>&nbsp;&nbsp;</TD>
<TD ALIGN=left NOWRAP><A HREF="omake-all-index.html">All</A>
&bull;&nbsp;<A HREF="omake-var-index.html">Variables</A>
&bull;&nbsp;<A HREF="omake-fun-index.html">Functions</A>
&bull;&nbsp;<A HREF="omake-obj-index.html">Objects</A>
&bull;&nbsp;<A HREF="omake-target-index.html">Targets</A>
&bull;&nbsp;<A HREF="omake-option-index.html">Options</A></TD>
</TR></TABLE>

<H1 CLASS="chapter"><A NAME="htoc311">Chapter&nbsp;11</A>&nbsp;&nbsp;Build functions</H1><UL>
<LI><A HREF="omake-rule.html#toc92">Builtin .PHONY targets</A>
<LI><A HREF="omake-rule.html#toc93">Options and versioning</A>
<LI><A HREF="omake-rule.html#toc94">Examining the dependency graph</A>
</UL>

<A NAME="chapter:rule"></A>

<A NAME="toc92"></A>
<H2 CLASS="section"><A NAME="htoc312">11.1</A>&nbsp;&nbsp;Builtin .PHONY targets</H2>
The complete set of builtin <CODE>.PHONY</CODE> targets include the following.
<DL CLASS="description" COMPACT=compact><DT CLASS="dt-description">
<B>.PHONY</B><DD CLASS="dd-description"> Declares new phony targets (Section&nbsp;<A HREF="omake-rules.html#target:.PHONY">7.10</A>).
<DT CLASS="dt-description"><B>.DEFAULT</B><DD CLASS="dd-description"> Declare the default build targets (Section&nbsp;<A HREF="omake-rules.html#target:.DEFAULT">7.7</A>).
<DT CLASS="dt-description"><B>.SUBDIRS</B><DD CLASS="dd-description"> Include a directory as part of the project (Section&nbsp;<A HREF="omake-rules.html#target:.SUBDIRS">7.8</A>).
<DT CLASS="dt-description"><B>.SCANNER</B><DD CLASS="dd-description"> Define a dependency scanner (Section&nbsp;<A HREF="omake-rules.html#target:.SUBDIRS">7.8</A>).
<DT CLASS="dt-description"><B>.INCLUDE</B><DD CLASS="dd-description"> Include a file (Section&nbsp;<A HREF="omake-rules.html#target:.INCLUDE">7.9</A>).
<DT CLASS="dt-description"><B>.ORDER</B><DD CLASS="dd-description"> Define a file-dependency ordering rule (Section&nbsp;<A HREF="omake-system.html#target:.ORDER">9.3.5</A>).
<DT CLASS="dt-description"><B>.BUILD_BEGIN</B><DD CLASS="dd-description"> Commands to be executed at the beginning of a build.
<DT CLASS="dt-description"><B>.BUILD_SUCCESS</B><DD CLASS="dd-description"> Commands to be executed if the build is successful.
<DT CLASS="dt-description"><B>.BUILD_FAILURE</B><DD CLASS="dd-description"> Commands to be executed if the build fails.
</DL>
<A NAME="@default286"></A><A NAME="@target9"></A><A NAME="target:.BUILD_BEGIN"></A>
<A NAME="@default287"></A><A NAME="@target10"></A><A NAME="target:.BUILD_SUCCESS"></A>
<A NAME="@default288"></A><A NAME="@target11"></A><A NAME="target:.BUILD_FAILURE"></A>
The <CODE>.BUILD</CODE> targets can be used to specify commands to be executed at
the beginning and end of the build. The <CODE>.BUILD_BEGIN</CODE> target is built
at the beginning of a project build, and one of <CODE>.BUILD_FAILURE</CODE> or
<CODE>.BUILD_SUCCESS</CODE> is executed when the build terminates.<BR>
<BR>
For example, the following set of rules simply print additional messages
about the status of the build.
<PRE CLASS="verbatim">
   .BUILD_BEGIN:
       echo Build starting

   .BUILD_SUCCESS:
       echo The build was successful

   .BUILD_FAILURE:
       println($"The build failed: $(length $(find-build-targets Failed)) targets could not be built")
</PRE>
Another common use is to define notifications to be performed when
the build completes. For example, the following rule will create
a new X terminal displaying the summary of the build
(see <CODE>BUILD_SUMMARY</CODE> in Section&nbsp;<A HREF="omake-base.html#var:BUILD_SUMMARY">8.1.12</A>).
<PRE CLASS="verbatim">
    .BUILD_FAILURE:
        xterm -e vi $(BUILD_SUMMARY)
</PRE>
If you do not wish to add these rules directly to your project (which
is probably a good idea if you work with others), you can
define them in your <CODE>.omakerc</CODE> (see Section&nbsp;<A HREF="omake-options.html#section:.omakerc">A.8</A>).<BR>
<BR>
The <CODE>find-build-targets</CODE> function (Section&nbsp;<A HREF="#fun:find-build-targets">11.3.3</A>
is useful for obtaining a firther summary of the build. Note that
when output diversions are in effect (with the <CODE>--output-*</CODE> options &mdash; see Chapter&nbsp;<A HREF="omake-options.html#chapter:options">A</A>),
any output produced by the commands is copied to a file. The name of the
file is specified by the <CODE>output-file</CODE> field of the <CODE>Target</CODE> object (Section&nbsp;<A HREF="omake-pervasives.html#obj:Target">12.1.11</A>).
You may find this useful in defining custom build summaries.
<A NAME="toc93"></A>
<H2 CLASS="section"><A NAME="htoc313">11.2</A>&nbsp;&nbsp;Options and versioning</H2>

<H3 CLASS="subsection"><A NAME="htoc314">11.2.1</A>&nbsp;&nbsp;OMakeFlags</H3><A NAME="@default289"></A><A NAME="@fun212"></A><A NAME="fun:OMakeFlags"></A>
<PRE CLASS="verbatim">
   OMakeFlags(options)
      options : String
</PRE>
The <CODE>OMakeFlags</CODE> function is used to set <CODE>omake</CODE> options from
within <TT>OMakefile</TT>s. The options have exactly the same format as
options on the command line.<BR>
<BR>
For example, the following code displays the progress bar unless
the <CODE>VERBOSE</CODE> environment variable is defined.
<PRE CLASS="verbatim">
    if $(not $(defined-env VERBOSE))
        OMakeFlags(-S --progress)
        export
</PRE>
<H3 CLASS="subsection"><A NAME="htoc315">11.2.2</A>&nbsp;&nbsp;OMakeVersion</H3><A NAME="@default290"></A><A NAME="@fun213"></A><A NAME="fun:OMakeVersion"></A>
<PRE CLASS="verbatim">
   OMakeVersion(version1)
   OMakeVersion(version1, version2)
      version1, version2 : String
</PRE>
The <CODE>OMakeVersion</CODE> function is used for version checking
in <TT>OMakefile</TT>s. It takes one or two arguments.<BR>
<BR>
In the one argument form, if the <TT>omake</TT> version number
is less than <CODE>&lt;version1&gt;</CODE>,
then an exception is raised. In the two argument form,
the version must lie between <CODE>version1</CODE> and <CODE>version2</CODE>.<BR>
<BR>

<H3 CLASS="subsection"><A NAME="htoc316">11.2.3</A>&nbsp;&nbsp;cmp-versions</H3><A NAME="@default291"></A><A NAME="@fun214"></A><A NAME="fun:cmp-versions"></A>
<PRE CLASS="verbatim">
   $(cmp-versions version1, version2)
      version1, version2 : String
</PRE>
The <CODE>cmp-versions\</CODE> functions can be used to compare arbitrary version strings.
It returns 0 when the two version strings are equal, a negative number when the first
string represents an earlier version, and a positive number otherwise.

<H3 CLASS="subsection"><A NAME="htoc317">11.2.4</A>&nbsp;&nbsp;DefineCommandVars</H3><A NAME="@default292"></A><A NAME="@fun215"></A><A NAME="fun:DefineCommandVars"></A>
<PRE CLASS="verbatim">
   DefineCommandVars()
</PRE>
The <CODE>DefineCommandVars</CODE> function redefines the variables passed on
the commandline. Variables definitions are passed on the command line
in the form <CODE>name=value</CODE>. This function is primarily for internal
use by <TT>omake</TT> to define these variables for the first time.
<A NAME="toc94"></A>
<H2 CLASS="section"><A NAME="htoc318">11.3</A>&nbsp;&nbsp;Examining the dependency graph</H2>

<H3 CLASS="subsection"><A NAME="htoc319">11.3.1</A>&nbsp;&nbsp;dependencies, dependencies-all, dependencies-proper</H3><A NAME="@default293"></A><A NAME="@fun216"></A><A NAME="fun:dependencies"></A><A NAME="@default294"></A><A NAME="@fun217"></A><A NAME="fun:dependencies-all"></A><A NAME="@default295"></A><A NAME="@fun218"></A><A NAME="fun:dependencies-proper"></A>
<PRE CLASS="verbatim">
   $(dependencies targets) : File Array
   $(dependencies-all targets) : File Array
   $(dependencies-proper targets) : File Array
      targets : File Array
   raises RuntimeException
</PRE>
The <CODE>dependencies</CODE> function returns the set of immediate dependencies of
the given targets. This function can only be used within a rule body and
all the arguments to the <CODE>dependency</CODE> function must also be dependencies of
this rule. This restriction ensures that all the dependencies are known when
this function is executed.<BR>
<BR>
The <CODE>dependencies-all</CODE> function is similar, but it expands the dependencies
recursively, returning all of the dependencies of a target, not just the immediate
ones.<BR>
<BR>
The <CODE>dependencies-proper</CODE> function returns all recursive dependencies, except
the dependencies that are leaf targets. A leaf target is a target that has no
dependencies and no build commands; a leaf target corresponds to a source file
in the current project.<BR>
<BR>
In all three functions, files that are not part of the current project are silently
discarded.<BR>
<BR>
One purpose of the <CODE>dependencies-proper</CODE> function is for &#8220;clean&#8221; targets.
For example, one way to delete all intermediate files in a build is with a rule
that uses the <CODE>dependencies-proper</CODE>. Note however, that the rule requires
building the project before it can be deleted. For a shorter form, see the
<CODE>filter-proper-targets</CODE> function.
<PRE CLASS="verbatim">
    .PHONY: clean

    APP = ...     # the name of the target application
    clean: $(APP)
       rm $(dependencies-proper $(APP))
</PRE>

<H3 CLASS="subsection"><A NAME="htoc320">11.3.2</A>&nbsp;&nbsp;target</H3><A NAME="@default296"></A><A NAME="@fun219"></A><A NAME="fun:target"></A>
<PRE CLASS="verbatim">
   $(target targets) : Target Array
      targets : File Sequence
   raises RuntimeException
</PRE>
The <CODE>target</CODE> function returns the Target object associated with each
of the targets. See the <CODE>Target</CODE> object for more information.

<H3 CLASS="subsection"><A NAME="htoc321">11.3.3</A>&nbsp;&nbsp;find-build-targets</H3><A NAME="@default297"></A><A NAME="@fun220"></A><A NAME="fun:find-build-targets"></A>
<PRE CLASS="verbatim">
    $(find-build-targets tag) : Target Array
       tag : Succeeded | Failed
</PRE>
The <CODE>find-build-targets</CODE> allow the results
of the build to be examined. The <CODE>tag</CODE> must
specifies which targets are to be returned; the comparison
is case-insensitive.
<DL CLASS="description" COMPACT=compact><DT CLASS="dt-description">
<B>Succeeded</B><DD CLASS="dd-description"> The list of targets that were built successfully.
<DT CLASS="dt-description"><B>Failed</B><DD CLASS="dd-description"> The list of targets that could not be built.
</DL>
These are used mainly in conjuction with the
<CODE>.BUILD_SUCCESS</CODE> (Section&nbsp;<A HREF="#target:.BUILD_SUCCESS">11.1</A>) and
<CODE>.BUILD_FAILURE</CODE> (Section&nbsp;<A HREF="#target:.BUILD_FAILURE">11.1</A>) phony targets.
For example, adding the following to your project <CODE>OMakefile</CODE>
will print the number of targets that failed (if the build failed).
<PRE CLASS="verbatim">
    .BUILD_FAILURE:
        echo "Failed target count: $(length $(find-build-targets Failed))"
</PRE>
<H3 CLASS="subsection"><A NAME="htoc322">11.3.4</A>&nbsp;&nbsp;project-directories</H3><A NAME="@default298"></A><A NAME="@fun221"></A><A NAME="fun:project-directories"></A>
<PRE CLASS="verbatim">
   $(project-directories) : Dir Array
</PRE>
The <CODE>project-directories</CODE> function returns the list of all directories
that are considered to be part of the project.<BR>
<BR>
To get the complete directory list, this function should be called
from within a rule body.

<H3 CLASS="subsection"><A NAME="htoc323">11.3.5</A>&nbsp;&nbsp;rule</H3><A NAME="@default299"></A><A NAME="@fun222"></A><A NAME="fun:rule"></A>
The <CODE>rule</CODE> function is called whenever a build rule is defined.
It is unlikely that you will need to redefine this function, except in
very exceptional cases.
<PRE CLASS="verbatim">
   rule(multiple, target, pattern, sources, options, body) : Rule
      multiple : String
      target   : Sequence
      pattern  : Sequence
      sources  : Sequence
      options  : Array
      body     : Body
</PRE>
The <CODE>rule</CODE> function is called when a rule is evaluated.
<DL CLASS="description" COMPACT=compact><DT CLASS="dt-description">
<B>multiple</B><DD CLASS="dd-description"> A Boolean value indicating whether the rule was defined
 with a double colon <CODE>::</CODE>.
<DT CLASS="dt-description"><B>target</B><DD CLASS="dd-description"> The sequence of target names.
<DT CLASS="dt-description"><B>pattern</B><DD CLASS="dd-description"> The sequence of patterns. This sequence will be empty
 for two-part rules.
<DT CLASS="dt-description"><B>sources</B><DD CLASS="dd-description"> The sequence of dependencies.
<DT CLASS="dt-description"><B>options</B><DD CLASS="dd-description"> An array of options. Each option is represented
 as a <CODE>Map</CODE> (Section&nbsp;<A HREF="omake-pervasives.html#obj:Map">12.1.2</A>) associating each specified option with
 a value.
<DT CLASS="dt-description"><B>body</B><DD CLASS="dd-description"> The body expression of the rule.
</DL>
Consider the following rule.
<PRE CLASS="verbatim">
   target: pattern: sources :name1: option1 :name2: option2
      expr1
      expr2
</PRE>
This expression represents the following function call, where
square brackets are used to indicate arrays, and the curly
brackets represent a <CODE>Map</CODE> (Section&nbsp;<A HREF="omake-pervasives.html#obj:Map">12.1.2</A>).
<PRE CLASS="verbatim">
   rule(false, target, pattern, sources,
        { $|:name1:| = option1; $|:name2:| = option2 }
        [expr1; expr2])
</PRE>


<TABLE CELLSPACING=2 CELLPADDING=0>
<TR><TD ALIGN=left NOWRAP>Jump to:</TD>
<TD VALIGN=top ALIGN=center NOWRAP>&nbsp;&nbsp;</TD>
<TD ALIGN=left NOWRAP><A HREF="http://omake.metaprl.org/">OMake Home</A>
&bull;&nbsp;<A HREF="omake.html">Guide Home</A>
&bull;&nbsp;<A HREF="omake-doc.html">Guide (single-page)</A>
&bull;&nbsp;<A HREF="omake-toc.html">Contents (short)</A>
&bull;&nbsp;<A HREF="omake-contents.html">Contents (long)</A></TD>
</TR>
<TR><TD ALIGN=left NOWRAP>Index:</TD>
<TD VALIGN=top ALIGN=center NOWRAP>&nbsp;&nbsp;</TD>
<TD ALIGN=left NOWRAP><A HREF="omake-all-index.html">All</A>
&bull;&nbsp;<A HREF="omake-var-index.html">Variables</A>
&bull;&nbsp;<A HREF="omake-fun-index.html">Functions</A>
&bull;&nbsp;<A HREF="omake-obj-index.html">Objects</A>
&bull;&nbsp;<A HREF="omake-target-index.html">Targets</A>
&bull;&nbsp;<A HREF="omake-option-index.html">Options</A></TD>
</TR></TABLE>
</BODY>
</HTML>
