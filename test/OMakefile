#
# Collect all tests.
#
TESTDIRS = $(dir $(set $(dirname $(find . -name Test[1-9]))))

runtest(subtest) =
    setenv(OMAKEFLAGS, $(EMPTY))
    setenv(OMAKEPATH, $(absname $(ROOT)/lib))
    PATH[] = $(absname $(ROOT)/src/main) $(PATH)
    setenv(PATH, $(concat $':', $(PATH)))
    if $(test -f $(subtest))
        echo "running osh $(subtest)" >> $(resultfile)
        res = $(shell-code osh $(subtest) >>& $(resultfile))
        export res
    elseif $(test -f $(subtest)/run.osh)
        cd $(subtest)
        echo "running osh run.osh" >>& $(resultfile)
        res = $(shell-code osh run.osh >>& $(resultfile))
        export res
    elseif $(test -f $(subtest)/OMakeroot -o -f $(subtest)/Root.om)
        cd $(subtest)
        echo "running omake in $(absname .)" >> $(resultfile)
        res = $(shell-code omake --no--progress >>& $(resultfile))
        export res
    else
        echo $"*** Don't know how to run tests in $(subtest)!" >> $(resultfile)
        eprintln($"*** Don't know how to run tests in $(subtest)!")
        res = 1
        export res
    return$(equal $(res), 0)

.STATIC:
    HAS_DATE = $(CheckProg date)

Shell. +=
    test(argv) =
        result = $"Tested $(in .., $(dir .)): "
        failures = false
        subtests = $(filter-exists Test)
        subtests += $(set $(glob i, Test[1-9]))
        if $(public.HAS_DATE)
            date > $(resultfile)
        else
            fprint($(resultfile), $"Stating tests in $(in $(ROOT), $(dir .)):")
        foreach(subtest, $(subtests))
            echo >> $(resultfile)
            echo $"==== $(subtest)" >> $(resultfile)
            if $(runtest $(subtest))
                result = $(result).
                echo "--- success" >> $(resultfile)
                export
            else
                result = $(result)E
                failures = true
                echo "*** failure" >> $(resultfile)
                export
            export
        if $(failures)
            result += $"$(nl)    *** SOME TESTS FAILED! See $(in $(ROOT), $(resultfile)) for detail"
            export
        println($(result))

.SUBDIRS: $(TESTDIRS)
    resultfile = $(file result.log)
    check: /.PHONY/all :effects: $(resultfile)
        test $(resultfile)

    clean:
        rm -f $(resultfile) *.omc Test*/.omakedb* Test*/*.omc Test*/stdout

CLEAN[] =
    awk/*/Subst.out
    shell/Test1/sub
    vmount/Test1/build/foo*
    vmount/Test1/src/*omc

clean:
    rm -rf *.omc $(CLEAN)
